<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="admin">

<!-- 관리자 가입 -->
<insert id="insertAdmin" parameterType="admins">
insert into ADMIN_INFO_TB values (admin_info_tb_SEQ.NEXTVAL,#{ad_id},#{ad_password},#{ad_nickname},#{ad_grade}) 
</insert>
<!-- 관리자 아이디체크 -->
<select id="adminIdCheck" parameterType="admins" resultType="admins">
SELECT ADMIN_NICKNAME as ad_nickname 
FROM admin_info_tb 
WHERE ADMIN_ID = #{ad_id}
</select>

<!-- 사용자 전체보기 -->
<select id="allMemberView" parameterType="members" resultType="members">
SELECT 
mb_id as memberId,
mb_name as memberName,
mb_nickname as memberNickName,
mb_gender as memberGender,
mb_birth as memberBirth,
mb_email as memberEmail,
mb_phone as memberPhone,
mb_regDate as memberRegDate,
MB_UPLOAD_PHOTO_FK as memberUploadPhotoNo
from member_entire_tb
</select>

<!-- 점주 전체보기 -->
<select id="allOwnerView" parameterType="owner" resultType="owner">
SELECT OW_ID as owId, 
	   OW_NAME as owName,
	   OW_EMAIL as owEmail,
	   OW_PHONE as phone,
	   OW_REGDATE as owRegDate, 
	   OW_BANK_ACCOUNT as owBankAccount 
	   from OWNER_ENTIRE_TB
</select>

<!-- 점주 검색 -->
<select id="ownerSearch" parameterType="map" resultType="owner">
SELECT OW_ID as owId,
	   OW_NAME as owName,
	   OW_EMAIL as owEmail,
	   OW_PHONE as phone,
	   OW_REGDATE as owRegDate, 
	   OW_BANK_ACCOUNT as owBankAccount 
	   FROM OWNER_ENTIRE_TB 
<where>
<choose>
<when test="combo == 'OwnerName'">
OW_NAME LIKE '%'|| #{keyword} ||'%' 
</when>
<otherwise>
OW_ID LIKE '%'|| #{keyword} ||'%' 
</otherwise>
</choose>
</where>
</select>

<!-- 사용자 검색 -->
<select id="memberSearch" parameterType="map" resultType="members">
SELECT 
mb_id as memberId,
mb_name as memberName,
mb_nickname as memberNickName,
mb_gender as memberGender,
mb_birth as memberBirth,
mb_email as memberEmail,
mb_phone as memberPhone,
mb_regDate as memberRegDate,
MB_UPLOAD_PHOTO_FK as memberUploadPhotoNo
from member_entire_tb
where 
<choose>
<when test="combo == 'MemberName'">
mb_name LIKE '%'|| #{keyword} ||'%' 
</when>
<when test="combo == 'MemberNickName'">
mb_nickname LIKE '%'|| #{keyword} ||'%' 
</when>
<otherwise>
mb_id LIKE '%'|| #{keyword} ||'%'  
</otherwise>
</choose>
</select>


<!-- 관리자 로그인 -->
<select id="adminLogin" parameterType="admins" resultType="admins">
SELECT 
ADMIN_INFO_PK as admin_info_pk, 
ADMIN_ID as ad_id, 
ADMIN_PASSWORD as ad_password, 
ADMIN_NICKNAME as ad_nickname, 
ADMIN_ACCESS_GRADE_FK as ad_grade 
from admin_info_tb where ADMIN_ID = #{ad_id} and ADMIN_PASSWORD = #{ad_password}
</select>

<!-- 통계 -->
<select id="statAdmin" resultType="statistics">
SELECT
    (SELECT COUNT(*) FROM MEMBER_entire_tb where MB_GENDER='M')as boy, 
    (SELECT COUNT(*) FROM MEMBER_entire_tb where MB_GENDER='F')as girl,
    (SELECT COUNT(*) FROM MEMBER_entire_tb WHERE (SELECT nvl(TRUNC(MONTHS_BETWEEN(sysdate, TO_DATE(to_char(MB_BIRTH,'yyyy'),'yyyy'))/12), 0) age FROM MEMBER_entire_tb) between 10 and 19)as age1020,
    (SELECT COUNT(*) FROM MEMBER_entire_tb WHERE (SELECT nvl(TRUNC(MONTHS_BETWEEN(sysdate, TO_DATE(to_char(MB_BIRTH,'yyyy'),'yyyy'))/12), 0) age FROM MEMBER_entire_tb) between 20 and 29)as age2030,
    (SELECT COUNT(*) FROM MEMBER_entire_tb WHERE (SELECT nvl(TRUNC(MONTHS_BETWEEN(sysdate, TO_DATE(to_char(MB_BIRTH,'yyyy'),'yyyy'))/12), 0) age FROM MEMBER_entire_tb) between 30 and 39)as age3040,
    (SELECT COUNT(*) FROM MEMBER_entire_tb WHERE (SELECT nvl(TRUNC(MONTHS_BETWEEN(sysdate, TO_DATE(to_char(MB_BIRTH,'yyyy'),'yyyy'))/12), 0) age FROM MEMBER_entire_tb) between 40 and 49)as age4050,
    (SELECT COUNT(*) FROM MEMBER_entire_tb WHERE (SELECT nvl(TRUNC(MONTHS_BETWEEN(sysdate, TO_DATE(to_char(MB_BIRTH,'yyyy'),'yyyy'))/12), 0) age FROM MEMBER_entire_tb) between 50 and 59)as age5060,
    (SELECT COUNT(*) FROM MEMBER_entire_tb WHERE (SELECT nvl(TRUNC(MONTHS_BETWEEN(sysdate, TO_DATE(to_char(MB_BIRTH,'yyyy'),'yyyy'))/12), 0) age FROM MEMBER_entire_tb)>=60)as age60,
    (select count(*) from MEMBER_BOOK_TB where to_char (MB_BOOK_DATE,'hh24') between 09 and 10)as time0910,
    (select count(*) from MEMBER_BOOK_TB where to_char (MB_BOOK_DATE,'hh24') between 11 and 12)as time1112,
    (select count(*) from MEMBER_BOOK_TB where to_char (MB_BOOK_DATE,'hh24') between 13 and 14)as time1314,
    (select count(*) from MEMBER_BOOK_TB where to_char (MB_BOOK_DATE,'hh24') between 15 and 16)as time1516,
    (select count(*) from MEMBER_BOOK_TB where to_char (MB_BOOK_DATE,'hh24') between 17 and 18)as time1718,
    (select count(*) from MEMBER_BOOK_TB where to_char (MB_BOOK_DATE,'hh24') between 19 and 24)as time1924,
    (select count(*) from OWNER_STORE_INFO_TB where OW_STORE_BIG_TYPE_FK=1)as korea,
    (select count(*) from OWNER_STORE_INFO_TB where OW_STORE_BIG_TYPE_FK=2)as china,
    (select count(*) from OWNER_STORE_INFO_TB where OW_STORE_BIG_TYPE_FK=3)as japan,
    (select count(*) from OWNER_STORE_INFO_TB where OW_STORE_BIG_TYPE_FK=4)as usa,
    (select count(*) from OWNER_STORE_INFO_TB where OW_STORE_BIG_TYPE_FK=5)as buffet,
    (select count(*) from OWNER_STORE_INFO_TB where OW_STORE_BIG_TYPE_FK=6)as dessert,
    (select count(*) from OWNER_STORE_INFO_TB where OW_STORE_BIG_TYPE_FK=7)as bar,
    (select count(*) from OWNER_STORE_INFO_TB where OW_STORE_BIG_TYPE_FK=8)as other,
    (select COUNT(*) FROM OWNER_ENTIRE_TB where OW_REGDATE between sysdate-300 and sysdate-6) as owall6day,
    (select COUNT(*) FROM MEMBER_entire_tb where MB_REGDATE between sysdate-300 and sysdate-6) as memall6day,
    (select COUNT(*) FROM OWNER_ENTIRE_TB where OW_REGDATE between sysdate-300 and sysdate-5) as owall5day,
    (select COUNT(*) FROM MEMBER_entire_tb where MB_REGDATE between sysdate-300 and sysdate-5) as memall5day,
    (select COUNT(*) FROM OWNER_ENTIRE_TB where OW_REGDATE between sysdate-300 and sysdate-4) as owall4day,
    (select COUNT(*) FROM MEMBER_entire_tb where MB_REGDATE between sysdate-300 and sysdate-4) as memall4day,
    (select COUNT(*) FROM OWNER_ENTIRE_TB where OW_REGDATE between sysdate-300 and sysdate-3) as owall3day,
    (select COUNT(*) FROM MEMBER_entire_tb where MB_REGDATE between sysdate-300 and sysdate-3) as memall3day,
    (select COUNT(*) FROM OWNER_ENTIRE_TB where OW_REGDATE between sysdate-300 and sysdate-2) as owall2day,
    (select COUNT(*) FROM MEMBER_entire_tb where MB_REGDATE between sysdate-300 and sysdate-2) as memall2day,
    (select COUNT(*) FROM OWNER_ENTIRE_TB where OW_REGDATE between sysdate-300 and sysdate-1) as owallyesterday,
    (select COUNT(*) FROM MEMBER_entire_tb where MB_REGDATE between sysdate-300 and sysdate-1) as memallyesterday,
    (select COUNT(*) FROM OWNER_ENTIRE_TB where OW_REGDATE between sysdate-300 and sysdate) as owalltoday,
    (select COUNT(*) FROM MEMBER_entire_tb where MB_REGDATE between sysdate-300 and sysdate) as memalltoday,
    (select COUNT(*) FROM OWNER_ENTIRE_TB) as ownerall,
    (SELECT COUNT(*) FROM member_entire_tb) as memberall,
    (select count(*) from member_store_review_tb) as hugi,
    (select count(*) from OWNER_ENTIRE_TB where to_char(OW_REGDATE,'YYMMDD') = TO_CHAR(SYSDATE,'YYMMDD'))as todaynewowner,
    (select count(*) from member_entire_Tb where to_char(MB_REGDATE,'YYMMDD') = TO_CHAR(SYSDATE,'YYMMDD'))as todaynewmember,
    (select count(*) from OWNER_ENTIRE_TB where to_char(OW_REGDATE,'YYMMDD') = TO_CHAR(SYSDATE-1,'YYMMDD'))as yesterdaynewowner,
    (select count(*) from member_entire_Tb where to_char(MB_REGDATE,'YYMMDD') = TO_CHAR(SYSDATE-1,'YYMMDD'))as yesternewmember,
    (select count(*) from OWNER_ENTIRE_TB where to_char(OW_REGDATE,'YYMMDD') = TO_CHAR(SYSDATE-2,'YYMMDD'))as threedaynewowner,
    (select count(*) from member_entire_Tb where to_char(MB_REGDATE,'YYMMDD') = TO_CHAR(SYSDATE-2,'YYMMDD'))as threedaynewmember,
    (select count(*) from OWNER_ENTIRE_TB where to_char(OW_REGDATE,'YYMMDD') = TO_CHAR(SYSDATE-3,'YYMMDD'))as fourdaynewowner,
    (select count(*) from member_entire_Tb where to_char(MB_REGDATE,'YYMMDD') = TO_CHAR(SYSDATE-3,'YYMMDD'))as fourdaynewmember,
    (select count(*) from OWNER_ENTIRE_TB where to_char(OW_REGDATE,'YYMMDD') = TO_CHAR(SYSDATE-4,'YYMMDD'))as fivedaynewowner,
    (select count(*) from member_entire_Tb where to_char(MB_REGDATE,'YYMMDD') = TO_CHAR(SYSDATE-4,'YYMMDD'))as fivedaynewmember,
    (select count(*) from OWNER_ENTIRE_TB where to_char(OW_REGDATE,'YYMMDD') = TO_CHAR(SYSDATE-5,'YYMMDD'))as sixdaynewowner,
    (select count(*) from member_entire_Tb where to_char(MB_REGDATE,'YYMMDD') = TO_CHAR(SYSDATE-5,'YYMMDD'))as sixdaynewmember,
    (select count(*) from OWNER_ENTIRE_TB where to_char(OW_REGDATE,'YYMMDD') = TO_CHAR(SYSDATE-6,'YYMMDD'))as sevendaynewowner,
    (select count(*) from member_entire_Tb where to_char(MB_REGDATE,'YYMMDD') = TO_CHAR(SYSDATE-6,'YYMMDD'))as sevendaynewmember,
    (select count(*) from MEMBER_entire_tb WHERE MB_REGDATE between sysdate-7  AND sysdate)as member7day,
    (select count(*) from MEMBER_entire_tb WHERE MB_REGDATE between sysdate-15 AND sysdate)as member15day,
    (select count(*) from MEMBER_entire_tb WHERE MB_REGDATE between sysdate-30 AND sysdate)as member30day,
    (select count(*) from OWNER_ENTIRE_TB WHERE OW_REGDATE between sysdate-7  AND sysdate)as owner7day,
    (select count(*) from OWNER_ENTIRE_TB WHERE OW_REGDATE between sysdate-15 AND sysdate)as owner15day,
    (select count(*) from OWNER_ENTIRE_TB WHERE OW_REGDATE between sysdate-30 AND sysdate)as owner30day,
    (select count(*) from member_signout_tb where (to_char(mb_signout_date,'YYMMDD')) = to_char(sysdate,'YYMMDD'))AS deletememtoday,
    (select count(*) from owner_signout_tb where (to_char(ow_signout_date,'YYMMDD')) = to_char(sysdate,'YYMMDD'))AS deleteowtoday,    
    (select count(*) from member_signout_tb where (to_char(mb_signout_date,'YYMMDD')) = to_char(sysdate-1,'YYMMDD'))AS deleteyestermemday,
    (select count(*) from owner_signout_tb where (to_char(ow_signout_date,'YYMMDD')) = to_char(sysdate-1,'YYMMDD'))AS deleteowyestermemday, 
    (select count(*) from member_signout_tb where (to_char(mb_signout_date,'YYMMDD')) = to_char(sysdate-2,'YYMMDD'))AS deletememthreeday,
    (select count(*) from owner_signout_tb where (to_char(ow_signout_date,'YYMMDD')) = to_char(sysdate-2,'YYMMDD'))AS deleteowthreeday, 
    (select count(*) from member_signout_tb where (to_char(mb_signout_date,'YYMMDD')) = to_char(sysdate-3,'YYMMDD'))AS deletememfourday,
    (select count(*) from owner_signout_tb where (to_char(ow_signout_date,'YYMMDD')) = to_char(sysdate-3,'YYMMDD'))AS deleteowfourday, 
    (select count(*) from member_signout_tb where (to_char(mb_signout_date,'YYMMDD')) = to_char(sysdate-4,'YYMMDD'))AS deletememfiveday,
    (select count(*) from owner_signout_tb where (to_char(ow_signout_date,'YYMMDD')) = to_char(sysdate-4,'YYMMDD'))AS deleteowfiveday, 
    (select count(*) from member_signout_tb where (to_char(mb_signout_date,'YYMMDD')) = to_char(sysdate-5,'YYMMDD'))AS deletememsixday,
    (select count(*) from owner_signout_tb where (to_char(ow_signout_date,'YYMMDD')) = to_char(sysdate-5,'YYMMDD'))AS deleteowsixday, 
    (select count(*) from member_signout_tb where (to_char(mb_signout_date,'YYMMDD')) = to_char(sysdate-6,'YYMMDD'))AS deletememsevenday,
    (select count(*) from owner_signout_tb where (to_char(ow_signout_date,'YYMMDD')) = to_char(sysdate-6,'YYMMDD'))AS deleteowsevenday, 
    (select count(*) from member_signout_tb WHERE mb_signout_date between sysdate-7   AND sysdate)as deletemem7day,
    (select count(*) from owner_signout_tb WHERE ow_signout_date between sysdate-7   AND sysdate)as deleteow7day,
    (select count(*) from member_signout_tb WHERE mb_signout_date between sysdate-15  AND sysdate)as deletemem15day,
    (select count(*) from owner_signout_tb WHERE ow_signout_date between sysdate-15   AND sysdate)as deleteow15day, 
    (select count(*) from member_signout_tb WHERE mb_signout_date between sysdate-30  AND sysdate)as deletemem30day,
    (select count(*) from owner_signout_tb WHERE ow_signout_date between sysdate-30   AND sysdate)as deleteow30day
FROM DUAL
</select>

<!-- 통계에서 가게순위 리스트  -->
<select id="storeList" resultType="com.kh.ynm.admin.model.vo.YNMStoreInfo">
select 
	   ow_store_name as name,
       book as book,
       grade as grade,
       jjim as jjim,
       favorite as favorite 
       from owner_store_info_tb,
(select                         
count(b.mb_entire_fk) as book,
avg(r.ow_store_review_star) as grade,
count(r.ow_store_jjim_check) as jjim,
count(f.mb_favorite_pk) as favorite
from owner_store_info_tb o
left join member_book_tb b on (o.ow_store_info_pk = b.ow_entire_fk) 
left join member_store_review_tb r on (o.ow_store_info_pk = r.ow_store_info_fk)
left join member_favorite_tb f on (o.ow_store_info_pk = f.ow_store_info_fk)
where r.ow_store_jjim_check='J'
order by b.mb_entire_fk DESC)
</select>

<!-- 관리자 수락/강등에서 관리자리스트 -->
<select id="adminList" resultType="admins">
select 
ADMIN_ID as ad_id,
ADMIN_PASSWORD as ad_password,
ADMIN_NICKNAME as ad_nickname,
ADMIN_ACCESS_GRADE_FK as ad_grade
from admin_info_tb
where ADMIN_ID not in ('admin')
</select>


<!-- 관리자 강등 -->
<update id="dounGrade">
UPDATE admin_info_tb 
SET ADMIN_ACCESS_GRADE_FK = 2 
WHERE ADMIN_ID = #{ad_id}
</update>
<!-- 관리자 승급 -->
<update id="upGrade">
UPDATE admin_info_tb
SET ADMIN_ACCESS_GRADE_FK = 1
WHERE ADMIN_ID = #{ad_id}
</update>

<!--게시판 페이징-->
<select id="noticeList" resultType="notice" parameterType="noticePageData">
select
NOTICE_NO_PK as noticeNo,
SUBJECT as subject,
CONTENTS as contents,
USERID as userId,
REGDATE as regDate
from (select notice.*,row_number() over(order by NOTICE_NO_PK desc) as num from notice)
where num between #{startPage} and #{endPage}
</select>
<!--from ( select owner_coupon_info_tb.*,row_number() over(order by OW_COUPON_INFO_PK desc) as num 
 		from owner_coupon_info_tb where OW_ENTIRE_FK=#{owEntirePk} and OW_STORE_INFO_FK=#{storeEntireFk})
	 	where num between #{startPage} and #{endPage} -->
 	
 	
<!--게시판 페이지 넘버링 -->
<select id="noticeTotal" parameterType="noticePageData" resultType="int">
select count(*) from notice
</select>


<select id="noticeView" parameterType="int" resultType="notice">
select
NOTICE_NO_PK as noticeNo,
SUBJECT as subject,
CONTENTS as contents,
USERID as userId,
REGDATE as regDate
from notice
where NOTICE_NO_PK = #{noticeNo}
</select>


<!-- 글 수정 -->
<update id="adminBoardFix" parameterType="notice">
 update notice set
 SUBJECT = #{subject},
 CONTENTS = #{contents}
 where NOTICE_NO_PK = #{noticeNo}



</update>
<!-- 글 삭제 -->
<delete id="adminBoardDelete" parameterType="notice">
delete from notice where NOTICE_NO_PK = #{noticeNo}
</delete>
</mapper>
