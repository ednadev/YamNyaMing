<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="stores">
	<insert id="storeAdd" parameterType="storeInfo">
		insert into owner_store_info_tb 
		values(owner_store_info_tb_SEQ.nextval, #{owEntireFk},
		#{owStoreBizNum}, #{owStoreName}, #{owStoreTel}, #{owBigTypeFk}, #{owSmallTypeFk},
		#{owStoreUrl},#{owStoreAddr},sysdate, #{owStoreMapInfo}, #{owStoreWorkingTime})
 	</insert> 
 	<select id="storeSearchWithBizNum" resultType="int">
 		select OW_STORE_INFO_PK from owner_store_info_tb 
 		where OW_STORE_BIZ_NUM = #{bizNum} 
 	</select>
 	
 	<insert id="menuUpload" parameterType="menuInfo">
 		insert into owner_menu_info_detail_tb 
 		values(owner_menu_info_detail_tb_SEQ.nextval,#{menuId}, #{menuTitle}, #{subTitle}, #{explain}, #{menuCost})
 	</insert>
 	
 	<select id="menuSelectWithId" resultType="int">
 		select ow_menu_info_detail_pk from owner_menu_info_detail_tb 
 		where ow_menu_id  = #{menuId} 
 	</select>
 	<insert id="storeDetailInfoInsert" parameterType="storeDetailInfo">
 		insert into owner_store_detail_tb 
 		values(owner_store_detail_tb_SEQ.nextval, #{owStoreInfoFk},  #{storeBigType}, #{storeSmallType}, #{owStoreLineComment},
 		  #{owStoreTip}, #{recommandMenu},  #{storeTableInfo}, #{budgetInfo},#{owSubInfo}, #{owDrinkListInfo},
 		  #{owStoreHeadPhoto},#{owStoreMenuTypeFk}, #{owStoreMenuInfoDetail},#{owStoreCostType})
 	</insert>
 	<insert id="couponEnroll" parameterType="couponEnrollData">
 		insert into owner_coupon_info_tb 
 		values(owner_coupon_info_tb_SEQ.nextval, #{owEntireFk}, #{owStoreInfoFk},
 		#{owCouponName}, #{owCouponCount}, #{owCouponStartDate},#{owCouponExpireDate}, 
 		#{owCouponDetail} )
 	</insert>
 	<select id="couponList" resultType="couponEnrollData" parameterType="couponPageData">
 		select
 			   ow_coupon_info_pk as owCouponInfoPk,
 			   ow_entire_fk as owEntireFk,
 			   ow_store_info_fk as owStoreInfoFk,
 			   ow_coupon_name as owCouponName,
 			   ow_coupon_count as owCouponCount,
 			   ow_coupon_start_date as owCouponStartDate,
 			   ow_coupon_expire_date as owCouponExpireDate,
 			   ow_coupon_detail as owCouponDetail
 		from ( select owner_coupon_info_tb.*,row_number() over(order by OW_COUPON_INFO_PK desc) as num 
 		from owner_coupon_info_tb where OW_ENTIRE_FK=#{owEntirePk} and OW_STORE_INFO_FK=#{storeEntireFk})
	 	where num between #{startPage} and #{endPage}
 	</select>
 	<select id="couponTotal" parameterType="couponPageData" resultType="int">
 		select count(*) from owner_coupon_info_tb
 		where OW_ENTIRE_FK=#{owEntirePk} and OW_STORE_INFO_FK=#{storeEntireFk}
 	</select>
 	
 	<select id="storeTitleList" parameterType="storePageData" resultType="storeTitleData">
 		select 	ow_store_info_pk as owStoreInfoPk, 
 				ow_entire_fk as owEntireFk, 
				ow_store_name as owStoreName,
				ow_store_tip as owStoreTip,
				ow_photo_route||'\'||ow_remake_name as owPhotoRoute,
			    (select avg(OW_STORE_REVIEW_STAR) from member_store_review_tb
            	where OW_ENTIRE_FK=ow_store_info_pk) as storeStarPoint 
			from owner_store_info_tb,
			(select * from owner_store_detail_tb, owner_store_photo_tb
			where OW_STORE_PHOTO_PK = substr(ow_store_head_photo,1,1))
			where ow_store_info_pk = OW_STORE_INDEX  and ow_entire_fk = #{owEntirePk}
 	</select>
 	<select id="storeEnrollNavi" resultType="int">
 		select count(*)
			from owner_store_info_tb,
			(select * from owner_store_detail_tb, owner_store_photo_tb
			where OW_STORE_PHOTO_PK = substr(ow_store_head_photo,1,1))
			where ow_store_info_pk = OW_STORE_INDEX  and ow_entire_fk = #{ownerIndex}
 	</select>
</mapper>